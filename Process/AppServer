# Check Docker
docker --version
docker ps

# Check Docker Compose
docker-compose --version

# Check CodeDeploy Agent
sudo service codedeploy-agent status

# Check Git
git --version

# Check AWS CLI
aws --version

# Verify DB IP was saved
cat /home/ubuntu/db_private_ip.txt

# Check if dtuser was created
id dtuser


# Install Nginx
sudo apt update
sudo apt install nginx -y

# Check Nginx status
sudo systemctl status nginx
systemctl enable nginx

# Stop Nginx for now (we'll configure it first)
sudo systemctl stop nginx



git clone https://github.com/TailAdmin/tailadmin-laravel.git
mv /home/ubuntu/tailadmin-laravel /var/www/
cd /var/www/tailadmin-laravel

# Check database folder structure
ls -la database/

# Check migrations
ls -la database/migrations/

# Check if there are any seeders
ls -la database/seeders/

# Check for SQL files
find database/ -name "*.sql"



rm /etc/nginx/sites-enabled/default
vim /etc/nginx/sites-available/tailadmin

server {
    listen 80;
    listen [::]:80;
    server_name _;
    
    root /var/www/tailadmin-laravel/public;
    index index.php index.html;

    access_log /var/log/nginx/tailadmin-access.log;
    error_log /var/log/nginx/tailadmin-error.log;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
  fastcgi_param SCRIPT_FILENAME /var/www/html/public$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}





ln -s /etc/nginx/sites-available/tailadmin /etc/nginx/sites-enabled/
nginx -t



vim Dockerfile

# Base PHP 8.2 FPM image
FROM php:8.2-fpm

# Set working directory
WORKDIR /var/www/html

# Install system dependencies
RUN apt-get update && apt-get install -y \
    libzip-dev zip unzip git curl libonig-dev libxml2-dev \
    && docker-php-ext-install pdo_mysql mbstring zip exif pcntl bcmath \
    && pecl install redis \
    && docker-php-ext-enable redis \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Composer globally
COPY --from=composer:2.7 /usr/bin/composer /usr/bin/composer

# Copy existing application
COPY . .

# Install PHP dependencies
RUN composer install --no-dev --optimize-autoloader

# Permissions for Laravel
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html \
    && chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache

# Expose port 9000 for FPM
EXPOSE 9000

# Start PHP-FPM
CMD ["php-fpm"]






vim docker-compose.yml

services:
  php-fpm:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tailadmin-php-fpm
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html
      - /var/www/html/vendor
    ports:
      - "9000:9000"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge




cp .env.example .env

vim .env

APP_NAME=Laravel
APP_ENV=production
APP_DEBUG=false
APP_KEY=
APP_URL=http://34.234.103.82

APP_LOCALE=en
APP_FALLBACK_LOCALE=en
APP_FAKER_LOCALE=en_US

APP_MAINTENANCE_DRIVER=file
# APP_MAINTENANCE_STORE=database

PHP_CLI_SERVER_WORKERS=4

BCRYPT_ROUNDS=12

LOG_CHANNEL=stack
LOG_STACK=single
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=debug

DB_CONNECTION=mysql
DB_HOST=172.31.90.231
DB_DATABASE=tailadmin_db
DB_USERNAME=tailadmin_user
DB_PASSWORD=TailAdminPass123!
DB_PORT=3306

SESSION_DRIVER=file
SESSION_LIFETIME=120
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=null

BROADCAST_CONNECTION=log
FILESYSTEM_DISK=local
QUEUE_CONNECTION=sync

CACHE_STORE=file
# CACHE_PREFIX=

MEMCACHED_HOST=127.0.0.1

REDIS_CLIENT=phpredis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=log
MAIL_SCHEME=null
MAIL_HOST=127.0.0.1
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null

MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false

VITE_APP_NAME="${APP_NAME}"




apt install mysql-client -y
DB_IP=$(cat /home/ubuntu/db_private_ip.txt)
echo "DB IP: $DB_IP"
mysql -h "$DB_IP" -u tailadmin_user -pTailAdminPass123! -e "SHOW DATABASES;"

sudo chown -R ubuntu:ubuntu /var/www/tailadmin-laravel
chmod -R 775 /var/www/tailadmin-laravel/storage
chmod -R 775 /var/www/tailadmin-laravel/bootstrap/cache
sudo chown ubuntu:ubuntu /var/www/tailadmin-laravel/.env
chmod 664 /var/www/tailadmin-laravel/.env

docker build -t tailadmin-php-fpm .

apt install composer -y

cd /home/ubuntu/tailadmin-laravel
composer install --no-dev --optimize-autoloader
sudo chown -R ubuntu:ubuntu /var/www/tailadmin-laravel
docker-compose up -d --build

# Check if running
docker ps


# Generate a random key
php -r "echo 'base64:' . base64_encode(random_bytes(32)) . PHP_EOL;"
(base64:iJZOQQhu76ji9jW/MnAslCpHSxGguDtm8AkgNUy/xVU=)
(Copy the output and update APP_KEY in the .env)

# Verify the key:
docker-compose exec php-fpm php artisan config:show app.key

# This will update the .env file inside the container
# Copy it back to host
docker-compose exec php-fpm cat .env | grep APP_KEY

#  Run Migrations
docker-compose exec php-fpm php artisan migrate --force

# Test DB connection:
docker-compose exec php-fpm php artisan migrate --force
> DB::connection()->getPdo();

# Clear and Cache Config
docker-compose exec php-fpm php artisan config:clear
docker-compose exec php-fpm php artisan config:cache
docker-compose exec php-fpm php artisan route:cache
docker-compose exec php-fpm php artisan view:cache
docker-compose exec php-fpm php artisan optimize


## Fix Permissions

# On host
# Give execute permission on /home/ubuntu so Nginx can traverse it
sudo chmod 755 /var/www/

# Fix the project directory
sudo chmod 755 /var/www/tailadmin-laravel
sudo chmod 755 /var/www/tailadmin-laravel/public

# Keep ownership with ubuntu
sudo chown -R ubuntu:ubuntu /var/www/tailadmin-laravel

# But give www-data access to storage
sudo chown -R www-data:www-data /var/www/tailadmin-laravel/storage
sudo chown -R www-data:www-data /var/www/tailadmin-laravel/bootstrap/cache
sudo chown -R www-data:www-data /var/www/tailadmin-laravel/storage
sudo chown -R www-data:www-data /var/www/tailadmin-laravel/bootstrap/cache
sudo chmod -R 775 /var/www/tailadmin-laravel/storage
sudo chmod -R 775 /var/www/tailadmin-laravel/bootstrap/cache

# In container
docker-compose exec php-fpm chown -R www-data:www-data /var/www/html/storage
docker-compose exec php-fpm chmod -R 775 /var/www/html/storage
docker-compose exec php-fpm chmod -R 775 /var/www/html/bootstrap/cache


## Start Nginx

# Test Nginx config
sudo nginx -t

# Start Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# Check status
sudo systemctl status nginx



### Build Frontend Assets
# Install NVM (doesn't need apt)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# Load NVM in current session
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Install Node 20
nvm install 20

# Set as default
nvm use 20

# Verify
node --version
npm --version


## Build Assets
# Install dependencies
npm install

# Build for production
npm run build

# Verify Build
ls -la public/build/

## Test Application
# Clear Laravel cache
docker-compose exec php-fpm php artisan config:cache

# Test
curl -I http://localhost
```

**Should return `HTTP/1.1 200 OK`**

---

## **Open in Browser**
```
http://18.207.181.44